<html>

<head>
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8">
    <title>Assignment 4: Visualization</title>
	<style>

	.counties {
	  fill: none;
	}


	.states {
	  fill: none;
	  stroke: #fff;
	  stroke-linejoin: round;
	}

	.q0-9 { fill:rgb(247,251,255); }
	.q1-9 { fill:rgb(222,235,247); }
	.q2-9 { fill:rgb(198,219,239); }
	.q3-9 { fill:rgb(158,202,225); }
	.q4-9 { fill:rgb(107,174,214); }
	.q5-9 { fill:rgb(66,146,198); }
	.q6-9 { fill:rgb(33,113,181); }
	.q7-9 { fill:rgb(8,81,156); }
	.q8-9 { fill:rgb(8,48,107); }
	.q9-9 { fill:rgb(190,190,190);}
	
	.pos_left {
		position: relative;
		left: 150px;
	}
	
	.mono {
		font-style: normal;
		font-size:x-small;
	}


	</style>
</head>

<body>
    <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-8">
            <div class="page-header center">
                <h1>Part 2: <small>Geomapping Tweet Sentiment</small></h1>
            </div>

             
            <h2>quantiles</h2>
			<p>
				I tried two different scale method. One is using quantize to evenly split the input domain [0,1] to 9 colors as did in the sample code. However, the color difference in the visualization is not obvious in this case, because sentiment data clusters in the middle of the input domain. There is not sentiment score higer than 0.9 or lower than 0.2 (except 0). So I change the scale method to quantile. I first store all nonzero sentiment scores in an array sent and use it as the input domain and quantile it into 9 colors so that each color has the same number of sentiment scores. If rateById map county id to zero, then the county don't have sentiment score. In this case, I map the county to grey color. The legend shows explicitly what is the quantiles.
			</p>
			<h2>visualization</h2>
        <div class="col-md-2">
        	
        </div>
    </div>

	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script>
	var margin = {top: 20, right: 10, bottom: 50, left: 10};
    var width = 960 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;

	var rateById = d3.map();
	var nameById = d3.map();


	var projection = d3.geo.albersUsa()
	.scale(1000)
	.translate([width / 2, height / 2]);

	var path = d3.geo.path()
	.projection(projection);
	
    var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

	var svg = d3.select("div").append("svg").attr("class", "pos_left")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	queue()
	.defer(d3.json, "us.json")
	.defer(d3.tsv, "county_sentiments.tsv", function(d) { rateById.set(d.id, +d.sent); nameById.set(d.id, d.name); })
	.await(ready);

	function notZero(element, index, array){
		return (element > 0)
	}

	function ready(error, us) {

		var sent = rateById.values().filter(notZero)
		var min = d3.min(sent), max = d3.max(sent)

		var quantize = d3.scale.quantile()
		.domain(sent)
		.range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));
	
		svg.append("g")
		.attr("class", "counties")
		.selectAll("path")
		.data(topojson.feature(us, us.objects.counties).features)
		.enter()
		.append("path")
		.attr("class", function(d) 
		{ if (rateById.get(d.id)!= 0) 
			return quantize(rateById.get(d.id)); 
			else 
				return "q9-9"; 
		})
		.attr("d", path)
		.append("title")
		.text(function(d) {return nameById.get(d.id);})
		.attr("d", path).transition();


		svg.append("path")
		.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
		.attr("class", "states")
		.attr("d", path);
		
		
		var gridSize = Math.floor(width / 30),
	    	legendElementWidth = gridSize*2,
		    left = 150;
		
		var legend = svg.selectAll(".legend")
		                .data([0,0.01].concat(quantize.quantiles()))
						.enter().append("g")
						.attr("class", "legend");
		
		legend.append("rect")
			  .attr("x", function(d, i) { return legendElementWidth * i + left; })
			  .attr("y", height-10)
			  .attr("width", legendElementWidth)
			  .attr("height", gridSize / 2)
			  .attr("class", function(d) { if (d==0) return "q9-9"; else return quantize(d);});
		
        legend.select("text").data([0,0].concat(quantize.quantiles())).enter()
			  .append("text")
              .attr("class", "mono")
              .text(function(d, i) { 
				  if (i==0) 
					  return "= 0";
				  else if (i==1)
					  return "> " + Number(d).toFixed(4);
				  else 
					  return "â‰¥ " + Number(d).toFixed(4); })
              .attr("x", function(d, i) { 
				  if (i==0) 
					  return legendElementWidth *  0.2 + left; 
				  else 
					  return legendElementWidth * i-1 + left; })
              .attr("y", height + gridSize/2);
			    
						
	}

	d3.select(self.frameElement).style("height", height + "px");

</script>
    <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-8">             
            <h2>analysis</h2>
			<p>
				From the visualization, Arizona, Maine have more darker colors, which means they contains more positve counties. West Virginia, Louisiana are most negative, because the proportion of white color in these area is high.
			</p>
			<p>
				<!-- From wikipedia, Arizona, West Virginia and Louisiana have very high poverty rate. The median household income by county I find in wikipedia is 2012, which is probably outdate. According to the wikipedia article, the median household income in Arizona, West Virginia and Louisiana are relatively low. On the contrary, Maine has a low poverty rate and relatively high median household income. From these data, Maine is most positive state -->
			In my opinion, <a href="http://upload.wikimedia.org/wikipedia/commons/c/cd/United_States_by_Gini_Coefficient.png">gini coefficient</a>, <a href="http://upload.wikimedia.org/wikipedia/commons/c/c4/US_Poverty_Rates.svg">poverty rate</a> and <a href="http://upload.wikimedia.org/wikipedia/commons/9/9e/US_county_household_median_income_2012.png">median income</a> may effect county seniment score in some sense. For example, West Virginia and Louisiana have very high poverty rate and low median household income which may cause negative sentiment in these states. However, Arizona has high poverty rate and low median household income as well, but on the contrary, Arizona is one of the most positive states. There should be other factors affecting the sentiments, for instance, weather, house price, commodity price, etc.
			</p>
        <div class="col-md-2">
        	
        </div>
    </div>
</body>
</html>
